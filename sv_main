ESX = nil
local Webhook = "Discord_webbhook"


RegisterServerEvent('g-drugnpc:buy')
AddEventHandler('g-drugnpc:buy', function(item, price, amount)
    print ('g-drugnpc:buyItem')
    print (item)
    print (price)
    print (amount)
    
    local _source = source
    local player = ESX.GetPlayerFromId(_source)
    if player.getMoney() >= price then
        player.removeMoney(price)
        player.addInventoryItem({
            item = item,
            count = amount
        })
        TriggerClientEvent('esx:showNotification', _source, 'Du köpte ' .. amount .. ' ' .. item .. ' för ' .. price .. 'kr' .. ' ')

        local identifierlist = ExtractIdentifiers(player.source)
        local data = {
            playerid = player.source,
            identifier = identifierlist.license:gsub("license2:", ""),
            discord = "<@"..identifierlist.discord:gsub("discord:", "")..">",
            steam = identifierlist.steam,
            message = player.name .. " köpte " .. amount .. " " .. item .. " för " .. price .. "kr"
        }
        noSession(data)
    else
        TriggerClientEvent('esx:showNotification', _source, 'Du har inte tillräckligt med cash')
    end
end)

function noSession(data)
	local color = '65352'
	local category = 'test'
	
	local information = {
		{
			["color"] = color,
			["author"] = {
				["icon_url"] = 'https://cdn.discordapp.com/attachments/869138252022575104/987700315136606268/dfgdfgdfgdf.png',
				["name"] = 'Gurkish - Logs',
			},
			["title"] = Config.Title,
			["description"] = '**ID:** '..data.playerid..'\n**Identifier:** '..data.identifier..'\n**Discord:** '..data.discord ..'\n**Steam:** '..data.steam ..  '\n\n' .. data.message .. ' **',
			["footer"] = {
				["text"] = os.date(Config.DateFormat),
			}
		}
	}

    PerformHttpRequest(Webhook, function(err, text, headers) end, 'POST', json.encode({username = 'Gurkish', embeds = information}), {['Content-Type'] = 'application/json'})
end

function ExtractIdentifiers(id)
    local identifiers = {
        steam = "",
        ip = "",
        discord = "",
        license = "",
        xbl = "",
        live = ""
    }

    for i = 0, GetNumPlayerIdentifiers(id) - 1 do
        local playerID = GetPlayerIdentifier(id, i)

        if string.find(playerID, "steam") then
            identifiers.steam = playerID
        elseif string.find(playerID, "ip") then
            identifiers.ip = playerID
        elseif string.find(playerID, "discord") then
            identifiers.discord = playerID
        elseif string.find(playerID, "license") then
            identifiers.license = playerID
        elseif string.find(playerID, "xbl") then
            identifiers.xbl = playerID
        elseif string.find(playerID, "live") then
            identifiers.live = playerID
        end
    end

    return identifiers
end
